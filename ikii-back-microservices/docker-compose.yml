version: '3'
services:
  mongo:
    image: mongo:4.2.7
    volumes:
      - db-mongo-data:/data/db
      - db-mongo-conf:/data/configdb
    ports:
      - "${MONGODB_PORT}:27017"
    networks:
      - network            
      
##---- INFRASTRUCTURE MICROSERVICES---- ##
  config:
    container_name: ikii-back-config-container
    build: ikii-back-config
    restart: always
    ports:
        - "${SERVER_CONFIG_PORT}:8888"  
    networks:
        - network
    logging:
      options:
        max-size: "10m"
        max-file: "10"                     
      
  registry:
    container_name: ikii-back-registry-container
    build: ikii-back-registry
    restart: always
    ports:
        - "${SERVER_REGISTRY_PORT}:8761" 
    networks:
        - network
    links:
        - config:config      
    depends_on:
      - config                                   
    logging:
      options:
        max-size: "10m"
        max-file: "10"    
        
  gateway:
    container_name: ikii-back-gateway-container
    build: ikii-back-gateway
    ports:
      - "${GATEWAY_PORT}:4000"
    networks:
      - network  
    links:
      - config:config
    depends_on:
      - config
      - registry            

##----FUNCTIONAL MICROSERVICES----##

  ikii-back-products:
    container_name: ikii-back-products-container
    build: ikii-back-products
    environment:
     - PROFILE_ACTIVE=prod
     - CLOUD_CONFIG=http://ikii-config-server:8888
    ports:
      - "8012:8012"
    networks:
      - network 
    links:
      - config:config
    depends_on:
      - config
      - registry
      - mongo   
      
  ikii-back-business:
    container_name: ikii-back-business-container
    build: ikii-back-business
    environment:
     - PROFILE_ACTIVE=prod
     - CLOUD_CONFIG=http://ikii-config-server:8888
    ports:
      - "8010:8010"
    networks:
      - network 
    links:
      - config:config
    depends_on:
      - config
      - registry
      - mongo
      
  ikii-back-users:
    container_name: ikii-back-users-container
    build: ikii-back-users
    ports:
      - "${USERS_PORT}:8002"   
    networks:
      - network 
    links:
      - config:config
    depends_on:
      - config
      - registry
      - mongo 

  ikii-back-security:
    container_name: ikii-back-security-container
    build: ikii-back-security
    ports:
      - "${SECURITY_PORT}:8003"  
      - "9003:8000" 
    networks:
      - network 
    links:
      - config:config
    depends_on:
      - config
      - registry
      - mongo                   
                 
networks:
  network:
    driver: bridge
    ipam:
      driver: default

volumes:
  db-mongo-data:
  db-mongo-conf:
